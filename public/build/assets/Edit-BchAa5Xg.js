import{v as z,r as m,U as k,j as e,$ as H,Y as J}from"./app-Be8ghtRb.js";import{A as q}from"./app-layout-BXVEw3EX.js";import{P as M,D as Y,H as K,F as U,T as X}from"./sonner-ORFq5qYP.js";import{B as h}from"./button-D1N9RrD0.js";import{I as u}from"./input-Co6CCOt6.js";import{L as d}from"./label-DPNJkhla.js";import{C as j}from"./checkbox-DjBb_Stx.js";import{C as f,a as _,b as g,c as v}from"./card-B8jOSnGI.js";import{S as N,a as b,b as S,c as y,d as C}from"./select-B4H269ix.js";import{T as Q}from"./textarea-B1dCnzMh.js";import{S as W}from"./separator-BCfRL23H.js";import{B as Z}from"./badge-DasfRpBM.js";import{t as l}from"./index-CuSu5bUe.js";import{X as ee}from"./index-wGWY3QV4.js";import{S as re,C as ae}from"./save-D8X6UB3U.js";import"./index-BQmSkEsW.js";import"./index-CCmhZsir.js";import"./index-Bvxqhwof.js";import"./app-logo-icon-Dxd9VO9-.js";import"./index-C7CVg9dv.js";function Se({formulario:s,estados:D,tiposFormulario:T,grupos:I}){const{data:i,setData:t,patch:p,processing:P,errors:a}=z({nombre:s.nombre||"",tipoformulario_id:s.tipoformulario_id.toString()||"",permite_edicion:s.permite_edicion||!1,identificador:s.identificador||"",form_estructura_json:s.form_estructura_json||"[]",estado_id:s.estado_id.toString()||"",grupo_id:s.grupo_id?s.grupo_id.toString():"",generate_pdf:s.generate_pdf||!1,send_pdf_email:s.send_pdf_email||!1,email_recipients:s.email_recipients||[],email_subject:s.email_subject||"",email_body:s.email_body||""}),[x,A]=m.useState(JSON.parse(s.form_estructura_json||"[]")),[G,n]=m.useState(!1),[F,L]=m.useState(null),[c,E]=m.useState("");m.useEffect(()=>{t("form_estructura_json",JSON.stringify(x))},[x,t]);const O=r=>{r.preventDefault();try{p(route("formularios.update",s.id),{_method:"patch"},{preserveScroll:!0,preserveState:!0,onSuccess:()=>{l.success("Guardado automático",{description:"La estructura del formulario ha sido guardada automáticamente."})},onError:o=>{l.error("Error de auto-guardado",{description:"No se pudo guardar automáticamente el formulario. Revisa la consola."}),console.error("Error en auto-guardado:",o)},onFinish:()=>{n(!1)}})}catch(o){console.error("Error inesperado durante el auto-guardado:",o),n(!1),l.error("Error inesperado",{description:"Ocurrió un error inesperado al intentar guardar el formulario."})}},B=k.useCallback(r=>{A(r)},[]),$=k.useCallback(async r=>{n(!0),console.log("Iniciando auto-guardado...",r);try{await p(route("formularios.update",s.id),{form_estructura_json:JSON.stringify(r),_method:"patch"},{preserveScroll:!0,preserveState:!0,onSuccess:()=>{L(new Date),l.success("Guardado automático",{description:"La estructura del formulario ha sido guardada automáticamente."}),console.log("Auto-guardado exitoso.")},onError:o=>{l.error("Error de auto-guardado",{description:"No se pudo guardar automáticamente el formulario. Revisa la consola."}),console.error("Error en auto-guardado:",o)},onFinish:()=>{n(!1)}})}catch(o){console.error("Error inesperado durante el auto-guardado:",o),n(!1),l.error("Error inesperado",{description:"Ocurrió un error inesperado al intentar guardar el formulario."})}},[s.id,p]),w=()=>{c&&!i.email_recipients.includes(c)&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(c)?(t("email_recipients",[...i.email_recipients,c]),E("")):l.error("Por favor ingresa un email válido"))},R=r=>{t("email_recipients",i.email_recipients.filter(o=>o!==r))},V=[{title:"Gestión de Formularios",href:"/formularios"},{title:`Editar Formulario: ${s.nombre}`,href:`/formularios/${s.id}/edit`}];return e.jsxs(q,{breadcrumbs:V,children:[e.jsx(H,{title:`Editar Formulario: ${s.nombre}`}),e.jsx("div",{className:"container mx-auto p-6",children:e.jsxs("form",{onSubmit:O,children:[e.jsxs(f,{className:"mb-6",children:[e.jsx(_,{children:e.jsx(g,{children:"Información General"})}),e.jsx(v,{className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"nombre",children:"Nombre del Formulario"}),e.jsx(u,{id:"nombre",type:"text",name:"nombre",value:i.nombre,className:"w-full",autoComplete:"nombre",onChange:r=>t("nombre",r.target.value),required:!0}),a.nombre&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.nombre})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"identificador",children:"Identificador (Opcional, se autogenera si está vacío)"}),e.jsx(u,{id:"identificador",type:"text",name:"identificador",value:i.identificador,className:"w-full",autoComplete:"identificador",onChange:r=>t("identificador",r.target.value)}),a.identificador&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.identificador})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"tipoformulario_id",children:"Tipo de Formulario"}),e.jsxs(N,{onValueChange:r=>t("tipoformulario_id",r),value:i.tipoformulario_id,children:[e.jsx(b,{className:"w-full",children:e.jsx(S,{placeholder:"Selecciona un tipo"})}),e.jsx(y,{children:T.map(r=>e.jsx(C,{value:r.id.toString(),children:r.nombre},r.id))})]}),a.tipoformulario_id&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.tipoformulario_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"estado_id",children:"Estado"}),e.jsxs(N,{onValueChange:r=>t("estado_id",r),value:i.estado_id,children:[e.jsx(b,{className:"w-full",children:e.jsx(S,{placeholder:"Selecciona un estado"})}),e.jsx(y,{children:D.map(r=>e.jsx(C,{value:r.id.toString(),children:r.nombre},r.id))})]}),a.estado_id&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.estado_id})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"grupo_id",children:"Grupo"}),e.jsxs(N,{onValueChange:r=>t("grupo_id",r),value:i.grupo_id,children:[e.jsx(b,{className:"w-full",children:e.jsx(S,{placeholder:"Selecciona un grupo"})}),e.jsx(y,{children:I.map(r=>e.jsx(C,{value:r.id.toString(),children:r.nombre},r.id))})]}),a.grupo_id&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.grupo_id})]}),e.jsxs("div",{className:"space-y-2 flex items-center col-span-full",children:[e.jsx(j,{id:"permite_edicion",checked:i.permite_edicion,onCheckedChange:r=>t("permite_edicion",r===!0)}),e.jsx(d,{htmlFor:"permite_edicion",className:"ml-2",children:"Permitir Edición después de ser completado"}),a.permite_edicion&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.permite_edicion})]})]})})]}),e.jsxs(f,{className:"mb-6",children:[e.jsx(_,{children:e.jsx(g,{children:"Configuración de PDF y Email"})}),e.jsxs(v,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"generate_pdf",checked:i.generate_pdf,onCheckedChange:r=>t("generate_pdf",r===!0)}),e.jsx(d,{htmlFor:"generate_pdf",children:"Generar PDF al completar el formulario"})]}),a.generate_pdf&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.generate_pdf}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(j,{id:"send_pdf_email",checked:i.send_pdf_email,onCheckedChange:r=>t("send_pdf_email",r===!0)}),e.jsx(d,{htmlFor:"send_pdf_email",children:"Enviar PDF por email"})]}),a.send_pdf_email&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.send_pdf_email}),i.send_pdf_email&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Destinatarios de Email"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(u,{type:"email",placeholder:"Ingresa un email",value:c,onChange:r=>E(r.target.value),onKeyPress:r=>{r.key==="Enter"&&(r.preventDefault(),w())}}),e.jsx(h,{type:"button",onClick:w,size:"sm",children:e.jsx(M,{className:"h-4 w-4"})})]}),i.email_recipients.length>0&&e.jsx("div",{className:"flex flex-wrap gap-2 mt-2",children:i.email_recipients.map((r,o)=>e.jsxs(Z,{variant:"secondary",className:"flex items-center gap-1",children:[r,e.jsx(ee,{className:"h-3 w-3 cursor-pointer",onClick:()=>R(r)})]},o))}),a.email_recipients&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.email_recipients})]}),e.jsx(W,{}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"email_subject",children:"Asunto del Email (Opcional)"}),e.jsx(u,{id:"email_subject",type:"text",placeholder:"Ej: Nuevo formulario completado - {nombre_formulario}",value:i.email_subject,onChange:r=>t("email_subject",r.target.value)}),e.jsx("p",{className:"text-sm text-gray-500",children:'Si se deja vacío, se usará: "Nuevo Envío de Formulario: [Nombre del Formulario]"'}),a.email_subject&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.email_subject})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{htmlFor:"email_body",children:"Mensaje del Email (Opcional)"}),e.jsx(Q,{id:"email_body",placeholder:"Escribe un mensaje personalizado que se incluirá en el email...",value:i.email_body,onChange:r=>t("email_body",r.target.value),rows:4}),e.jsx("p",{className:"text-sm text-gray-500",children:"Si se deja vacío, se mostrará un mensaje predeterminado con los datos del formulario."}),a.email_body&&e.jsx("div",{className:"text-red-500 text-sm mt-1",children:a.email_body})]})]})]})]}),e.jsxs(f,{children:[e.jsxs(_,{className:"flex flex-row items-center justify-between",children:[e.jsx(g,{children:"Diseñador de Formulario"}),e.jsx("div",{className:"flex items-center gap-2",children:G?e.jsxs("span",{className:"text-sm text-muted-foreground animate-pulse flex items-center gap-1",children:[e.jsx(re,{className:"h-4 w-4 text-primary"})," Guardando..."]}):F&&e.jsxs("span",{className:"text-sm text-green-600 flex items-center gap-1",children:[e.jsx(ae,{className:"h-4 w-4"})," Guardado ",F.toLocaleTimeString()]})})]}),e.jsx(v,{children:e.jsx(Y,{backend:K,children:e.jsx(U,{initialFormStructure:x,onFormStructureChange:B,onSaveFormStructure:$,autoSaveInterval:2e4})})})]}),e.jsxs("div",{className:"flex items-center justify-end mt-6",children:[e.jsx(J,{href:route("formularios.index"),children:e.jsx(h,{variant:"outline",className:"mr-4",children:"Cancelar"})}),e.jsx(h,{type:"submit",disabled:P,children:"Actualizar Formulario"})]})]})}),e.jsx(X,{})]})}export{Se as default};
